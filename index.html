<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Page Splitter with GHL Upload</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'></svg>">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #pdfLinks {
      margin-top: 20px;
    }
    #pdfLinks a {
      display: block;
      margin: 5px 0;
      color: #007bff;
      text-decoration: none;
    }
    #pdfLinks a:hover {
      text-decoration: underline;
    }
    #uploadStatus {
      margin-top: 20px;
      color: green;
    }
    #uploadStatus.error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Split PDF and Upload to GHL Media Library</h1>
  <div class="form-group">
    <label for="firstName">First Name:</label>
    <input type="text" id="firstName" placeholder="Enter first name">
  </div>
  <div class="form-group">
    <label for="lastName">Last Name:</label>
    <input type="text" id="lastName" placeholder="Enter last name">
  </div>
  <div class="form-group">
    <label for="clientId">Contact ID:</label>
    <input type="text" id="clientId" placeholder="Enter contact ID">
  </div>
  <div class="form-group">
    <label for="pdfFile">Upload PDF:</label>
    <input type="file" id="pdfFile" accept="application/pdf">
  </div>
  <button onclick="splitAndUploadPDF()">Split and Upload PDFs</button>
  <div id="pdfLinks"></div>
  <div id="uploadStatus"></div>

  <script>
    let pdfUrls = [];
    const accessToken = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdXRoQ2xhc3MiOiJMb2NhdGlvbiIsImF1dGhDbGFzc0lkIjoicVFvYWVISzhUVlZKQ1dYVHROV04iLCJzb3VyY2UiOiJJTlRFR1JBVElPTiIsInNvdXJjZUlkIjoiNjhhNGIzMjAwNDhiNTczYjA2ZWZhMzQwLW1laXRoYTZ2IiwiY2hhbm5lbCI6Ik9BVVRIIiwicHJpbWFyeUF1dGhDbGFzc0lkIjoicVFvYWVISzhUVlZKQ1dYVHROV04iLCJvYXV0aE1ldGEiOnsic2NvcGVzIjpbIm1lZGlhcy5yZWFkb25seSIsIm1lZGlhcy53cml0ZSIsImNvbnRhY3RzLnJlYWRvbmx5IiwiY29udGFjdHMud3JpdGUiXSwiY2xpZW50IjoiNjhhNGIzMjAwNDhiNTczYjA2ZWZhMzQwIiwidmVyc2lvbklkIjoiNjhhNGIzMjAwNDhiNTczYjA2ZWZhMzQwIiwiY2xpZW50S2V5IjoiNjhhNGIzMjAwNDhiNTczYjA2ZWZhMzQwLW1laXRoYTZ2In0sImlhdCI6MTc1NjQ5MzMwOC41MTcsImV4cCI6MTc1NjU3OTcwOC41MTd9.SbgkpxDLlOYgFTp5rnMfi2d-wKWtSZnZZOeAVTehkMnDmNReQA_-E92RKT57NSFBMVqrPumfN1kk8tRmswWiMQCkyxrIwHTnV7HtD32iW6-tc0_49FO30TjDH60mB8amkTVlf3ByVjBtCk9x4vr9CfRORzsrsRgGbXrOU5520d5KhuvN1enzRD1DVg_oKW51qcwm-X3aePc_2QAHcWSWI8GEndQH7gKSR00mrrG5KfvyBafzGIz8Y-jFr5C-ttLO61nD6kDuWAjlk-ewPDlPxq2ytZmGMLIMirnr1ywudTjUeM0bSCQNAqd7RYNChdRceMLQNhu0xsaPt5Kz-v5f4YyrOhnpmIGlC1XQYTo0xGcnqDPWAR-wvHuslIzEyyUUUJqGtkhrJmPhs-37dFG4hXXhCskdZSqBVQnhdQVxA6sEQCTJ0lXK0uTbTE6qUoa2hGOHcCMjt667SkKyLJMcaP-kfXznEsYik81CbSF5oPYvCt3uP14-MdhfkPe9U6E222PUtQ-9APRrcMuEn2KvIRE3UbNN0yYkMfJ8q94z5eZ4AaZINpI8XfF8BN6mMgMDRc9tlvSYcLRwixRYRoPhjwVyVNsbQdslwE26LrZ-TJ_t3_ziwTmp4K6DUoyZshGlASRa4s_mLLRtioZDaFb6cSDbebRkKd5sulJxlDJsJ_U';

    async function uploadToGHLMedia(pdfBlob, fileName) {
      const url = 'https://services.leadconnectorhq.com/medias/upload-file';
      const form = new FormData();
      form.append('file', pdfBlob, fileName);
      form.append('hosted', '');
      form.append('fileUrl', '');
      form.append('name', fileName);
      form.append('parentId', '');

      const options = {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${accessToken}`,
          Version: '2021-07-28',
          Accept: 'application/json'
        },
        body: form
      };

      try {
        console.log(`Attempting to upload ${fileName} to GHL Media Library`);
        console.log(`Using access token: ${accessToken.substring(0, 20)}...`);
        
        const response = await fetch(url, options);
        const data = await response.json();
        console.log(`Upload response status: ${response.status}`);
        console.log(`Upload response data:`, data);

        if (!response.ok) {
          console.error('GHL Upload Response:', data);
          if (response.status === 401) {
            throw new Error('Unauthorized: Invalid or expired access token. Please update the access token in the code.');
          } else if (response.status === 400) {
            throw new Error(`Bad Request: ${data.message || 'Invalid request parameters'}`);
          } else if (response.status === 403) {
            throw new Error(`Forbidden: ${data.message || 'Access denied'}`);
          } else if (response.status === 413) {
            throw new Error(`Payload Too Large: ${data.message || 'File too large'}`);
          }
          throw new Error(data.message || `Failed to upload ${fileName} (Status: ${response.status})`);
        }
        console.log(`Successfully uploaded ${fileName} to GHL Media Library`);
        return data;
      } catch (error) {
        console.error(`Error uploading ${fileName} to GHL:`, error);
        if (error instanceof TypeError && error.message.includes('fetch')) {
          throw new Error(`Network error: Unable to connect to GHL server. Please check your internet connection. (${error.message})`);
        }
        throw error;
      }
    }

    async function splitAndUploadPDF() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const clientId = document.getElementById('clientId').value.trim();
      const pdfFileInput = document.getElementById('pdfFile');
      const pdfLinksContainer = document.getElementById('pdfLinks');
      const uploadStatus = document.getElementById('uploadStatus');

      pdfLinksContainer.innerHTML = '';
      uploadStatus.innerHTML = '';
      pdfUrls.forEach(url => URL.revokeObjectURL(url));
      pdfUrls = [];

      if (!firstName || !lastName || !clientId) {
        alert('Please fill in all fields (First Name, Last Name, Contact ID).');
        return;
      }

      if (!pdfFileInput.files || pdfFileInput.files.length === 0) {
        alert('Please upload a PDF file.');
        return;
      }

      try {
        const file = pdfFileInput.files[0];
        const arrayBuffer = await file.arrayBuffer();

        // Validate PDF and log first 10 bytes for debugging
        const firstBytes = new Uint8Array(arrayBuffer.slice(0, 10));
        const pdfSignature = new TextDecoder().decode(firstBytes);
        console.log('First 10 bytes of uploaded file:', pdfSignature, firstBytes);
        if (!pdfSignature.startsWith('%PDF-')) {
          throw new Error('Uploaded file is not a valid PDF (missing PDF header). First 10 bytes: ' + pdfSignature);
        }

        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
        const pageCount = pdfDoc.getPageCount();

        if (pageCount === 0) {
          alert('The uploaded PDF is empty.');
          return;
        }

        uploadStatus.innerHTML = 'Splitting PDF and generating links...';

        for (let i = 0; i < pageCount; i++) {
          const newDoc = await PDFLib.PDFDocument.create();
          const [page] = await newDoc.copyPages(pdfDoc, [i]);
          newDoc.addPage(page);

          // Create blank header page
          const headerDoc = await PDFLib.PDFDocument.create();
          const headerPage = headerDoc.addPage([595, 842]); // A4 size in points

          const [headerPageCopy] = await newDoc.copyPages(headerDoc, [0]);
          newDoc.insertPage(0, headerPageCopy);

          const pdfBytes = await newDoc.save();
          const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
          const pdfUrl = URL.createObjectURL(pdfBlob);
          pdfUrls.push(pdfUrl);

          const fileName = `${firstName}_${lastName}_${clientId}_Page${i + 1}.pdf`;
          const link = document.createElement('a');
          link.href = pdfUrl;
          link.download = fileName;
          link.textContent = `${firstName} ${lastName} ${clientId} Page ${i + 1}`;
          pdfLinksContainer.appendChild(link);

          uploadStatus.innerHTML = `Uploading ${fileName} to GHL...`;
          await uploadToGHLMedia(pdfBlob, fileName);
          uploadStatus.innerHTML += `<br>Uploaded ${fileName} to GHL Media Library.`;
        }

        alert(`Generated and uploaded ${pageCount} PDF(s) successfully! Click the links below to download.`);
        uploadStatus.innerHTML += `<br>All ${pageCount} PDFs uploaded to GHL Media Library.`;
        
        // Store PDF information in localStorage
        storeClientPDFs(clientId, firstName, lastName, pdfUrls);
      } catch (error) {
        uploadStatus.className = 'error';
        uploadStatus.innerHTML = `Error: ${error.message}`;
        console.error('Full error details:', error);
        if (error.stack) {
          console.error('Error stack trace:', error.stack);
        }
        alert(`An error occurred: ${error.message}`);
      }
    }

    function storeClientPDFs(clientId, firstName, lastName, pdfUrls) {
      try {
        // Get existing data from localStorage
        const storedData = localStorage.getItem('generatedPdfs');
        const allPdfs = storedData ? JSON.parse(storedData) : {};
        
        // Initialize array for this client if it doesn't exist
        if (!allPdfs[clientId]) {
          allPdfs[clientId] = [];
        }
        
        // Add new PDFs to the client's list
        const timestamp = new Date().toISOString();
        pdfUrls.forEach((url, index) => {
          const fileName = `${firstName}_${lastName}_${clientId}_Page${index + 1}.pdf`;
          allPdfs[clientId].push({
            firstName,
            lastName,
            clientId,
            fileName,
            url,
            timestamp
          });
        });
        
        // Save updated data to localStorage
        localStorage.setItem('generatedPdfs', JSON.stringify(allPdfs));
        console.log(`Stored ${pdfUrls.length} PDF(s) for client ${clientId}`);
      } catch (error) {
        console.error('Error storing PDF information:', error);
      }
    }

    window.addEventListener('unload', () => {
      pdfUrls.forEach(url => URL.revokeObjectURL(url));
    });
  </script>
</body>
</html>